<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>3D Keychain Preview</title>
<style>
    body { margin: 0; overflow: hidden; background: #ffffff; }
</style>
</head>

<body>
<div id="preview" style="width:100vw; height:100vh;"></div>

<!-- THREE.JS from jsDelivr (CORS safe) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>

<!-- CORS-SAFE OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>

<!-- CORS-SAFE FontLoader -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/FontLoader.js"></script>

<!-- CORS-SAFE TextGeometry -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/geometries/TextGeometry.js"></script>

<script>
let scene, camera, renderer, controls;
let keychainBody, holeMesh, textMesh;
let loadedFont = null;

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        1,
        2000
    );
    camera.position.set(0, 80, 220);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById("preview").appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(100, 100, 100);
    scene.add(dir);

    const loader = new THREE.FontLoader();
    loader.load(
        "https://cdn.jsdelivr.net/npm/three@0.128/examples/fonts/helvetiker_bold.typeface.json",
        font => {
            loadedFont = font;
            buildKeychain("Your Name", "#ff0000", "#000000");
        }
    );

    animate();
}

function buildKeychain(text, topColor, baseColor) {
    if (!loadedFont) return;

    if (keychainBody) scene.remove(keychainBody);
    if (holeMesh) scene.remove(holeMesh);
    if (textMesh) scene.remove(textMesh);

    const plateGeo = new THREE.BoxGeometry(160, 50, 6);
    const plateMat = new THREE.MeshPhongMaterial({ color: baseColor });
    keychainBody = new THREE.Mesh(plateGeo, plateMat);
    scene.add(keychainBody);

    const holeGeo = new THREE.CylinderGeometry(8, 8, 10, 32);
    holeMesh = new THREE.Mesh(holeGeo, new THREE.MeshPhongMaterial({ color: 0xffffff }));
    holeMesh.rotation.x = Math.PI / 2;
    holeMesh.position.set(-70, 0, 0);
    scene.add(holeMesh);

    const txtGeo = new THREE.TextGeometry(text, {
        font: loadedFont,
        size: 22,
        height: 4
    });

    txtGeo.computeBoundingBox();
    const xOffset = -(txtGeo.boundingBox.max.x - txtGeo.boundingBox.min.x) / 2;
    const yOffset = -10;

    const textMat = new THREE.MeshPhongMaterial({ color: topColor });
    textMesh = new THREE.Mesh(txtGeo, textMat);
    textMesh.position.set(xOffset, yOffset, 4);
    scene.add(textMesh);
}

window.onmessage = e => {
    const d = e.data;
    buildKeychain(d.text, d.topColor, d.baseColor);
};

function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
    controls.update();
}

init();
</script>

</body>
</html>

