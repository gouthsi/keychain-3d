<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>3D Keychain Preview</title>
<style>
    body { margin: 0; overflow: hidden; background: #ffffff; }
    #preview { width: 100vw; height: 100vh; }
</style>
</head>

<body>
<div id="preview"></div>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://threejs.org/examples/js/loaders/FontLoader.js"></script>
<script src="https://threejs.org/examples/js/geometries/TextGeometry.js"></script>

<script>

// GLOBALS
let scene, camera, renderer, controls;
let keychainBody, holeMesh, textMesh;
let fontLoaded = null;

// INIT SCENE
function init() {

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.set(0, 60, 220);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById("preview").appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // LIGHTS
    const light1 = new THREE.DirectionalLight(0xffffff, 1);
    light1.position.set(50, 50, 100);
    scene.add(light1);

    const light2 = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(light2);

    // LOAD FONT
    const loader = new THREE.FontLoader();
    loader.load("https://threejs.org/examples/fonts/helvetiker_bold.typeface.json", font => {
        fontLoaded = font;
        buildKeychain("Your Name", "#ff0000", "#000000");
    });

    animate();
}

// BUILD THE FULL KEYCHAIN
function buildKeychain(text, textColor, baseColor) {

    if (!fontLoaded) return;

    // REMOVE OLD OBJECTS
    if (keychainBody) scene.remove(keychainBody);
    if (holeMesh) scene.remove(holeMesh);
    if (textMesh) scene.remove(textMesh);

    // ----------------------------------------
    // KEYCHAIN RECTANGLE BODY
    // ----------------------------------------
    const bodyWidth = 160;
    const bodyHeight = 50;
    const bodyDepth = 6;

    const bodyGeo = new THREE.BoxGeometry(bodyWidth, bodyHeight, bodyDepth);
    const bodyMat = new THREE.MeshPhongMaterial({ color: baseColor });
    keychainBody = new THREE.Mesh(bodyGeo, bodyMat);
    scene.add(keychainBody);

    // ----------------------------------------
    // HOLE ON LEFT SIDE
    // ----------------------------------------
    const holeGeo = new THREE.CylinderGeometry(8, 8, bodyDepth + 1, 32);
    const holeMat = new THREE.MeshPhongMaterial({ color: "#ffffff" });

    holeMesh = new THREE.Mesh(holeGeo, holeMat);
    holeMesh.rotation.x = Math.PI / 2;
    holeMesh.position.set(-bodyWidth/2 + 15, 0, 0);
    scene.add(holeMesh);

    // ----------------------------------------
    // EXTRUDED TEXT ON TOP
    // ----------------------------------------
    const textGeo = new THREE.TextGeometry(text, {
        font: fontLoaded,
        size: 22,
        height: 4,
        bevelEnabled: false
    });

    textGeo.computeBoundingBox();

    const textXOffset = - (textGeo.boundingBox.max.x - textGeo.boundingBox.min.x) / 2;
    const textYOffset = -10;

    const textMat = new THREE.MeshPhongMaterial({ color: textColor });
    textMesh = new THREE.Mesh(textGeo, textMat);
    textMesh.position.set(textXOffset, textYOffset, bodyDepth / 2);
    scene.add(textMesh);
}

// RECEIVE MESSAGES FROM WIX
window.onmessage = (e) => {
    const d = e.data;
    buildKeychain(d.text, d.topColor, d.baseColor);
};

// RENDER LOOP
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

init();

</script>
</body>
</html>
