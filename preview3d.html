<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>3D Keychain Text Preview</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #ffffff;
    }
    #preview {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="preview"></div>

  <!-- Three.js (CORS-safe) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/FontLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/geometries/TextGeometry.js"></script>

  <script>
    let scene, camera, renderer, controls;
    let keychainGroup = null;
    let loadedFont = null;
    let userInteracted = false;

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        1,
        2000
      );
      camera.position.set(0, 70, 220);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById("preview").appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      controls.addEventListener("start", () => {
        userInteracted = true;
      });

      // lighting
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));

      const d1 = new THREE.DirectionalLight(0xffffff, 0.8);
      d1.position.set(80, 120, 100);
      scene.add(d1);

      const d2 = new THREE.DirectionalLight(0xffffff, 0.4);
      d2.position.set(-60, -80, -40);
      scene.add(d2);

      // LOAD YOUR FONT HERE (IMPORTANT)
      const loader = new THREE.FontLoader();
      loader.load(
        "https://gouths.github.io/keychain-3d/gill_sans_heavy.typeface.json",  // TODO: replace with real URL
        (font) => {
          loadedFont = font;
          buildKeychain("Your Name", "#ff0000", "#000000");
        }
      );

      window.addEventListener("resize", onResize);
      animate();
    }

    function onResize() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }

    function buildKeychain(text, topColor, baseColor) {
      if (!loadedFont) return;
      if (!text || text.trim().length === 0) text = "Your Name";

      if (keychainGroup) {
        scene.remove(keychainGroup);
        keychainGroup.traverse((o) => {
          if (o.geometry) o.geometry.dispose();
          if (o.material) o.material.dispose();
        });
      }

      keychainGroup = new THREE.Group();

      // proportions
      const topHeight = 1.8;   // text thickness
      const baseHeight = 4;    // base thickness
      const fontSize   = 20;   // base font size

      const textGeo = new THREE.TextGeometry(text, {
        font: loadedFont,
        size: fontSize,
        height: topHeight,
        bevelEnabled: true,
        bevelThickness: 0.35,
        bevelSize: 0.25,
        bevelSegments: 3,
        curveSegments: 8,
      });

      textGeo.computeBoundingBox();
      const bb = textGeo.boundingBox;
      const w = bb.max.x - bb.min.x;
      const h = bb.max.y - bb.min.y;

      const cx = -(bb.max.x + bb.min.x) / 2;
      const cy = -(bb.max.y + bb.min.y) / 2;

      const MAX_WIDTH = 150;
      const scaleFactor = w > 0 ? MAX_WIDTH / w : 1;

      // --- TOP LAYER (front text) ---
      const topMat = new THREE.MeshPhongMaterial({ color: topColor });
      const topMesh = new THREE.Mesh(textGeo, topMat);
      topMesh.position.set(cx, cy, baseHeight); // sits on top of base
      keychainGroup.add(topMesh);

      // --- BASE LAYER (true contour offset, no sideways shift) ---
      const baseGeo = textGeo.clone();
      const baseMat = new THREE.MeshPhongMaterial({ color: baseColor });
      const baseMesh = new THREE.Mesh(baseGeo, baseMat);

      // slightly larger all around, BUT same center (no XY offset)
      const BASE_SCALE = 1.08; // a touch bigger so border shows evenly
      baseMesh.scale.set(BASE_SCALE, BASE_SCALE, baseHeight / topHeight);
      baseMesh.position.set(cx, cy, 0); // exactly under text, projected from back
      keychainGroup.add(baseMesh);

      // scale for long names
      keychainGroup.scale.set(scaleFactor, scaleFactor, scaleFactor);

      // gentle tilt for nicer view
      keychainGroup.rotation.x = -0.22;

      scene.add(keychainGroup);
    }

    // from Wix
    window.onmessage = (e) => {
      const d = e.data || {};
      buildKeychain(
        d.text || "Your Name",
        d.topColor || "#ff0000",
        d.baseColor || "#000000"
      );
    };

    function animate() {
      requestAnimationFrame(animate);

      if (!userInteracted && keychainGroup) {
        keychainGroup.rotation.y += 0.01;
      }

      controls.update();
      renderer.render(scene, camera);
    }

    init();
  </script>
</body>
</html>


